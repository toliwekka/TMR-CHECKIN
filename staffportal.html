<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>TMR International | T-Check Portal</title>
        <link rel="icon" type="image/png" href="./logo.png" />

        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
        <!-- FullCalendar -->
        <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
        <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

        <!-- Toastify -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
        <style>
            :root {
                --mint-green: #006c9c; /* TMR Deep Blue replacing Mint Green */
                --light-gray: #e6f4f9; /* Light blue-tinted background */
                --dark-gray: #003d5b; /* Deep TMR Header/Text color */
                --text-color: #004c74; /* Mid-tone TMR Blue for regular text */
            }

            body {
                font-family: "Poppins", sans-serif;
            }

            /* Sidebar Styling */
            .sidebar {
                background-color: var(--mint-green);
                color: white;
                height: 100%;
                width: 250px;
                padding-top: 20px;
            }

            .sidebar-item:hover {
                background-color: rgba(46, 190, 142, 0.2);
                transition: background-color 0.3s ease;
            }

            .sidebar-icon {
                width: 20px;
                height: 20px;
                margin-right: 12px;
            }

            /* Card Styling */
            .card {
                background-color: white;
                border-radius: 15px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                padding: 24px;
                transition: box-shadow 0.3s ease;
            }

            .card:hover {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            }

            /* Progress Circle */
            .progress-circle {
                background: conic-gradient(#34d399 0% 50%, #f87171 50% 100%);
                border-radius: 50%;
                width: 120px;
                height: 120px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 24px;
                color: #1f2937;
            }
        </style>

        <style>
            /* Full CSS (Styling, Glass, Animations) */
            h1 {
                text-align: center;
                margin-top: 20px;
                font-weight: 600;
                font-size: 28px;
            }
            #calendar {
                margin: 20px auto;
                max-width: 1100px;
                background: rgba(255, 255, 255, 0.6);
                backdrop-filter: blur(14px);
                border-radius: 20px;
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
                padding: 20px;
                animation: fadeIn 1s ease;
            }
            .fab {
                position: fixed;
                bottom: 30px;
                right: 30px;
                width: 60px;
                height: 60px;
                background: #34d399;
                border-radius: 50%;
                color: white;
                font-size: 32px;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                transition: background 0.3s ease;
            }
            .fab:hover {
                background: #059669;
            }
            .modal {
                display: none;
                position: fixed;
                z-index: 2000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                overflow-y: auto;
                animation: fadeIn 0.5s ease;
            }
            .modal-content {
                background: #fff;
                margin: 50px auto;
                padding: 20px;
                width: 400px;
                border-radius: 16px;
                animation: slideDown 0.5s ease;
            }
            .modal-content input,
            .modal-content textarea,
            .modal-content select {
                width: 100%;
                margin-bottom: 12px;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid #ccc;
                font-size: 14px;
            }
            button {
                background: #34d399;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 10px;
                cursor: pointer;
                font-weight: bold;
                margin-top: 10px;
                width: 100%;
            }
            button:hover {
                background: #059669;
            }
            #deleteTask {
                background: #f87171;
            }
            #deleteTask:hover {
                background: #dc2626;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }
            @keyframes slideDown {
                from {
                    transform: translateY(-50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        </style>
    </head>
    <body class="bg-light-gray font-sans">
        <div class="flex">
            <!-- Sidebar -->
            <aside class="sidebar p-6">
                <div class="mb-8">
                    <h1 class="text-2xl font-bold text-white">TMR Staff</h1>
                </div>
                <nav>
                    <ul>
                        <li class="sidebar-item flex items-center py-3">
                            <span class="sidebar-icon">üìù</span>
                            <a href="assessmentintroa.html" class="text-lg text-white">Start Your Check-In</a>
                        </li>
                        <li class="sidebar-item flex items-center py-3">
                            <span class="sidebar-icon">üìä</span>
                            <a href="#" class="text-lg text-white">System Overview</a>
                        </li>
                        <li class="sidebar-item flex items-center py-3 opacity-20 cursor-not-allowed">
                            <span class="sidebar-icon">‚ö†Ô∏è</span>
                            <a href="#" class="text-lg text-white">Risk Monitor</a>
                        </li>
                        <li class="sidebar-item flex items-center py-3 opacity-20 cursor-not-allowed">
                            <span class="sidebar-icon">üîó</span>
                            <a href="#" class="text-lg text-white">System Integrations</a>
                        </li>
                        <li class="sidebar-item flex items-center py-3 opacity-20 cursor-not-allowed">
                            <span class="sidebar-icon">üìù</span>
                            <span class="text-lg text-white">Health Reports</span>
                            <ul class="pl-6 mt-2">
                                <li><a href="#" class="text-white">Environment Pulse</a></li>
                                <li><a href="#" class="text-white">Cognitive Load</a></li>
                                <li><a href="#" class="text-white">Life-Work Balance</a></li>
                                <li><a href="#" class="text-white">Resilience Gauge</a></li>
                                <li><a href="#" class="text-white">Stress Level</a></li>
                            </ul>
                        </li>
                    </ul>
                </nav>
                <div class="mt-6">
                    <h2 class="text-sm font-semibold text-white">Support Hub</h2>
                    <ul class="mt-4">
                        <li class="sidebar-item flex items-center py-3 opacity-20 cursor-not-allowed">
                            <span class="sidebar-icon">üì±</span>
                            <a href="#" class="text-white">App Support</a>
                        </li>
                        <li class="sidebar-item flex items-center py-3">
                            <span class="sidebar-icon">üìà</span>
                            <a href="#" class="text-white">Data Insights</a>
                        </li>
                        <li class="sidebar-item flex items-center py-3">
                            <span class="sidebar-icon">üìÖ</span>
                            <a href="#" class="text-white">Well-being Scheduler</a>
                        </li>
                        <li class="sidebar-item flex items-center py-3 opacity-20 cursor-not-allowed">
                            <span class="sidebar-icon">üíº</span>
                            <a href="#" class="text-white">Service Offerings</a>
                        </li>
                    </ul>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8">
                <header class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-bold text-#8f4141">TMR Staff Dashboard</h2>
                    <div class="flex space-x-4"></div>
                </header>

                <!-- Health Score Section -->
                <section class="card mb-6">
                    <h3 class="text-lg font-semibold text-#8f4141"><span id="userName"></span>, your journey so far has led to these results. Let‚Äôs see what they reveal!</h3>

                    <div class="mt-4 flex justify-center items-center">
                        <section class="card mb-6">
                            <h2>üß† Mental Well-Being Snapshot</h2>
                            <p><strong>Raw Score:</strong> <span id="partA-raw">--</span> / 70</p>
                            <p><strong>Percentage:</strong> <span id="partA-percent">--</span></p>
                            <p><strong>Status:</strong> <span id="partA-status">--</span></p>
                            <em id="partA-comment">Awaiting analysis...</em>
                        </section>
                        <section class="card mb-6">
                            <h2>üéØ Behavioral Evaluation</h2>
                            <p><strong>Raw Score:</strong> <span id="partB-raw">--</span> / 240</p>
                            <p><strong>Percentage:</strong> <span id="partB-percent">--</span></p>
                            <p><strong>Status:</strong> <span id="partB-status">--</span></p>
                            <em id="partB-comment">Awaiting data...</em>
                        </section>
                    </div>
                    <div class="mt-4 flex justify-center items-center">
                        <div class="chart-area">
                            <div id="gaugeA"></div>
                        </div>
                        <div class="chart-area">
                            <div id="gaugeB"></div>
                        </div>
                    </div>
                </section>

                <!-- Appointment Incoming -->
                <section class="card mb-6">
                    <h3 class="text-lg font-semibold text-#8f4141">Appointment Incoming, It‚Äôs On the Calendar</h3>
                    <ul class="mt-4 text-sm text-gray-500">
                        <div id="calendar" style="width: 100vw; height: 50vh; margin: 40px auto; overflow: hidden;"></div>
                        <!-- Modal -->

                        <div id="taskModal" class="modal">
                            <div class="modal-content">
                                <h3>Add / Edit Task</h3>
                                <input type="text" id="taskTitle" placeholder="Task Title" />
                                <textarea id="taskDescription" placeholder="Description"></textarea>
                                <select id="taskIcon">
                                    <option value="">Choose Icon</option>
                                    <option>üßò Meditation</option>
                                    <option>üé® Art Therapy</option>
                                    <option>üìù Journaling</option>
                                    <option>üéß Music Relaxation</option>
                                    <option>üö∂ Mindful Walk</option>
                                    <option>üìö Reading Therapy</option>
                                    <option>üí¨ Talk Therapy</option>
                                    <option>üè• T|Check-Point</option>
                                    <option>üìÜ Book Session</option>
                                </select>
                                <select id="taskMood">
                                    <option value="">Mood</option>
                                    <option>Happy</option>
                                    <option>Calm</option>
                                    <option>Motivated</option>
                                    <option>Stressed</option>
                                    <option>Sad</option>
                                </select>
                                <select id="taskPriority">
                                    <option value="">Priority</option>
                                    <option>High</option>
                                    <option>Medium</option>
                                    <option>Low</option>
                                </select>
                                <input type="date" id="taskDate" />
                                <input type="time" id="taskStartTime" />
                                <input type="time" id="taskEndTime" />
                                <button id="saveTask">Save Task</button>
                                <button id="deleteTask">Delete Task</button>
                                <button onclick="closeModal()">Cancel</button>
                            </div>
                        </div>
                    </ul>
                    <button class="mt-4 bg-mint-green text-white px-4 py-2 rounded shadow">Download Results</button>
                </section>
            </main>
        </div>

        <!-- ‚úÖ Firebase + Firestore Setup and Data Fetch -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
            import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyDeDsOiA6QP4qbedd_JmQ9na1hM3sf4y3Q",
                authDomain: "mentalhealthtracker-15563.firebaseapp.com",
                projectId: "mentalhealthtracker-15563",
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            let progressChartInstance = null;

            const first = localStorage.getItem("form_005_first-name")?.trim();
            const last = localStorage.getItem("form_006_surname")?.trim();
            const email = localStorage.getItem("form_007_email")?.trim()?.toLowerCase();

            if (!first || !last || !email) {
                alert("Missing user information in localStorage.");
            } else {
                const q = query(collection(db, "tmrstaffResponses"), where("form_005_first-name", "==", first), where("form_006_surname", "==", last), where("form_007_email", "==", email));

                getDocs(q)
                    .then((snapshot) => {
                        if (snapshot.empty) {
                            alert("No assessments found for these details.");
                            return;
                        }

                        const partA = [];
                        const partB = [];
                        const events = [];

                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const scoreA = parseFloat(data.form_062_PartA_Score);
                            const scoreB = parseFloat(data.form_064_PartB_Score);

                            if (!isNaN(scoreA)) partA.push(scoreA);
                            if (!isNaN(scoreB)) partB.push(scoreB);

                            if (data.form_000_evaluationDate) {
                                const firstName = data["form_005_first-name"]?.trim() || "";
                                const lastName = data["form_006_surname"]?.trim() || "";
                                const fullName = `${firstName} ${lastName}`.trim() || "Assessment Taken";

                                const userNameElement = document.getElementById("userName");
                                if (userNameElement) userNameElement.textContent = fullName;

                                localStorage.setItem("lastFullName", fullName);

                                events.push({
                                    title: "üìù Assessment",
                                    start: data.form_000_evaluationDate,
                                    extendedProps: {
                                        scoreA: !isNaN(scoreA) ? scoreA : null,
                                        scoreB: !isNaN(scoreB) ? scoreB : null,
                                        fullName: fullName,
                                    },
                                });
                            }
                        });

                        if (window.Chart) {
                        }
                    })
                    .catch((err) => {
                        console.error("Error fetching Firestore data:", err);
                    });
            }

            function average(arr1, arr2) {
                const all = [...arr1, ...arr2];
                if (!all.length) return 0;
                return all.reduce((a, b) => a + b, 0) / all.length;
            }
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const name = localStorage.getItem("form_005_first-name") || "Your";
                const capitalized = name.charAt(0).toUpperCase() + name.slice(1).toUpperCase();
                document.getElementById("userName").textContent = `${capitalized},`;
            });

            // Global variables
            let AScore = 0;
            let BScore = 0;
            let percA = 0;
            let percB = 0;

            const maxA = 70;
            const maxB = 240;

            const heroMessages = [
                "üß† Your emotional gauge reveals how you've been feeling deep down‚Äîemotionally, socially, and cognitively.",
                "üí° A higher score in Part A often reflects inner resilience, calm, and mental clarity.",
                "üéØ Your functional score captures how you‚Äôre managing daily life, routines, responsibilities, and support systems.",
                "‚öñÔ∏è Balance across emotional and functional areas is key to overall well-being.",
                "üìà Bar charts offer a clear comparison between emotional and functional states‚Äîside by side.",
                "üç© Donut visuals provide a quick glance at where you stand and where you can grow.",
                "üìä Each chart is a mirror‚Äîreflecting not just scores, but trends and possibilities.",
                "üß≠ Think of these results as a compass, not a destination. They're here to guide you, not define you.",
                "üå± Scores shift as life shifts. These insights are a moment-in-time snapshot to help you realign.",
                "üõ†Ô∏è Use the feedback to build better habits, deeper connections, and healthier boundaries.",
                "üìå Remember: no score can capture your full complexity‚Äîit simply opens the door to deeper reflection.",
                "ü´Ç You are not your numbers. You're a story in motion‚Äîthis is just one meaningful chapter.",
                "üåà Wellness is a spectrum. Wherever you land, there‚Äôs a path forward.",
                "üî• High scores show you're thriving. Lower scores signal where you may need support or change.",
                "üí¨ Each insight is an invitation to check in with yourself and your environment.",
            ];

            // Rotate messages
            let heroIndex = 0;
            setInterval(() => {
                const heroEl = document.getElementById("heroText");
                if (heroEl) {
                    heroIndex = (heroIndex + 1) % heroMessages.length;
                    heroEl.textContent = heroMessages[heroIndex];
                }
            }, 5000);

            // On page load

            window.onload = function () {
                getStoredData(); // Call the function to fetch the data
            };

            window.addEventListener("DOMContentLoaded", () => {
                // Initial fetch of the scores from localStorage
                AScore = parseInt(localStorage.getItem("form_042_PartA_Score")) || 0;
                BScore = parseInt(localStorage.getItem("form_044_PartB_Score")) || 0;

                // If the values are already set, proceed with the calculations
                if (AScore !== 0 && BScore !== 0) {
                    percA = parseFloat(((AScore / maxA) * 100).toFixed(2));
                    percB = parseFloat(((BScore / maxB) * 100).toFixed(2));

                    updateScores(AScore, BScore);
                    updateTextContent(AScore, BScore, percA, percB);
                    plotGauges(percA, percB);
                    renderAllCharts(percA, percB);
                } else {
                    getStoredData(); // If the values aren't set, fetch again
                }
            });

            // Function to fetch data from localStorage and retry if it's not yet available
            function getStoredData() {
                const tempAScore = localStorage.getItem("form_062_PartA_Score");
                const tempBScore = localStorage.getItem("form_064_PartB_Score");

                // If the scores are not yet available, retry after 100ms
                if (tempAScore === null || tempBScore === null) {
                    setTimeout(getStoredData, 400); // Retry every 100ms until values are found
                } else {
                    // Once the data is available, update the scores
                    AScore = parseInt(tempAScore);
                    BScore = parseInt(tempBScore);

                    // Recalculate percentages after data is available
                    percA = parseFloat(((AScore / maxA) * 100).toFixed(2));
                    percB = parseFloat(((BScore / maxB) * 100).toFixed(2));

                    updateScores(AScore, BScore);
                    updateTextContent(AScore, BScore, percA, percB);
                    plotGauges(percA, percB);
                    renderAllCharts(percA, percB);
                }
            }

            function updateScores(AScore, BScore) {
                const scoreAElement = document.getElementById("scoreA");
                const scoreBElement = document.getElementById("scoreB");
                const totalScoreElement = document.getElementById("totalScore");

                if (scoreAElement) scoreAElement.textContent = `AScore: ${AScore}`;
                if (scoreBElement) scoreBElement.textContent = `BScore: ${BScore}`;
                if (totalScoreElement) totalScoreElement.textContent = `Total Score: ${AScore + BScore}`;
            }

            function updateTextContent(rawA, rawB, percA, percB) {
                document.getElementById("partA-raw").textContent = rawA;
                document.getElementById("partA-percent").textContent = `${percA}%`;
                document.getElementById("partA-status").textContent = getPartAStatus(percA);
                document.getElementById("partA-comment").textContent = getPartAComment(percA);

                document.getElementById("partB-raw").textContent = rawB;
                document.getElementById("partB-percent").textContent = `${percB}%`;
                document.getElementById("partB-status").textContent = getPartBStatus(percB);
                document.getElementById("partB-comment").textContent = getPartBComment(percB);
            }

            function getPartAStatus(score) {
                if (score < 57) return "Below Optimal (Severe concern)";
                if (score < 63) return "Watchful (Borderline)";
                if (score < 86) return "Generally Stable (Mild issues)";
                return "Thriving (Excellent)";
            }

            function getPartAComment(percentage) {
                const messages = [
                    {
                        range: [0, 57],
                        list: [
                            "It looks like you‚Äôve had a tough time recently. You‚Äôre not alone ‚Äî let's take the first step toward getting the support you deserve.",
                            "Your emotional well-being matters. Let‚Äôs explore ways to strengthen your resilience and find moments of peace.",
                            "This score suggests a heavy emotional load. It‚Äôs okay to seek help, and small steps can lead to powerful healing.",
                            "You‚Äôre doing the best you can, and that‚Äôs enough for now. Let's work together to lighten your emotional burden.",
                            "There‚Äôs strength in acknowledging when things feel overwhelming. You're not alone in this journey.",
                            "Let‚Äôs pause and breathe. The storm may be strong, but so is your potential to rise above it.",
                        ],
                    },
                    {
                        range: [57.01, 63],
                        list: [
                            "You‚Äôre at a delicate balance ‚Äî not too low, but not quite where you might want to be. A small shift could make a big difference.",
                            "You‚Äôre doing okay, but there‚Äôs room for upliftment. Let‚Äôs focus on building daily emotional wins.",
                            "Your emotional state shows resilience with some signs of weariness. You‚Äôve got what it takes to bounce back.",
                            "You‚Äôve come this far ‚Äî now let‚Äôs strengthen your momentum toward well-being.",
                            "You're at a pivot point ‚Äî with some intentional care, things can start looking up.",
                            "This is a reminder that even moderate progress is still progress. Let‚Äôs add a little spark to your emotional wellness.",
                        ],
                    },
                    {
                        range: [63.01, 86],
                        list: [
                            "You‚Äôre managing well emotionally ‚Äî great job. Let‚Äôs keep nurturing what‚Äôs working and gently improve what isn‚Äôt.",
                            "There‚Äôs evidence of solid emotional grounding here. Keep building on those positive foundations.",
                            "You‚Äôre in a stable space emotionally. That‚Äôs something to celebrate!",
                            "Your emotional awareness is evident ‚Äî you‚Äôre doing the inner work, and it shows.",
                            "This is a good emotional health zone. Let‚Äôs keep reinforcing these habits and insights.",
                            "You're showing strength and balance. A few intentional actions could elevate you even further.",
                        ],
                    },
                    {
                        range: [86.01, 100],
                        list: [
                            "Outstanding emotional strength! You‚Äôre radiating resilience and inner peace.",
                            "This score reflects a high level of emotional clarity and wellness. Keep shining.",
                            "You‚Äôre in a powerful emotional space. Let‚Äôs harness that to uplift others too.",
                            "Your emotional well-being is exceptional. Keep nurturing what helps you thrive.",
                            "You‚Äôve cultivated an inner calm that‚Äôs both rare and inspiring.",
                            "Your emotional energy is vibrant and centered ‚Äî a beautiful state to be in.",
                        ],
                    },
                ];

                return pickAComment(percentage, messages);
            }

            function pickAComment(percentage, messages) {
                const messageGroup = messages.find(({ range }) => percentage >= range[0] && percentage <= range[1]);

                if (messageGroup && messageGroup.list.length > 0) {
                    const randomIndex = Math.floor(Math.random() * messageGroup.list.length);
                    return messageGroup.list[randomIndex];
                } else {
                    return "No comment available for this score.";
                }
            }

            function getPartBStatus(score) {
                if (score < 29) return "Critical (Severe concern)";
                if (score < 54) return "Needs Attention (Significant concern)";
                if (score < 79) return "Needs Improvement (Mild concern)";
                return "Functioning Well (Healthy range)";
            }

            function getPartBComment(percentage) {
                const messages = [
                    {
                        range: [0, 29],
                        list: [
                            "Your support system and sense of belonging may need strengthening. Let's explore ways to help you feel more connected and supported.",
                            "This score suggests you're experiencing some social or environmental disconnection. You're not alone, and things can improve with the right support.",
                            "It seems like your current environment might not be meeting your emotional or relational needs. Let‚Äôs identify what could make things better.",
                            "Everyone needs a safe space to thrive ‚Äî let‚Äôs work on building or rebuilding that for you.",
                            "Support is essential to growth. Let's find the people and places that lift you up.",
                        ],
                    },
                    {
                        range: [29.01, 54],
                        list: [
                            "You're navigating through some ups and downs in your external environment. Let‚Äôs strengthen the supportive elements around you.",
                            "There‚Äôs potential for greater connection and comfort in your surroundings. A few key shifts can bring big change.",
                            "Your environment is somewhat stable, but there's room for improvement. Let‚Äôs boost your sense of safety and support.",
                            "You‚Äôre making it work ‚Äî now let‚Äôs make it better. A bit more structure or support could elevate your environment.",
                            "Progress is showing, but there‚Äôs space to create more meaningful support systems. You're on the right path.",
                        ],
                    },
                    {
                        range: [54.01, 79],
                        list: [
                            "You‚Äôve built a relatively supportive environment ‚Äî great work. Let‚Äôs keep improving what‚Äôs already working.",
                            "This score shows you're surrounded by helpful elements, with just a few gaps to close. You're almost there!",
                            "You‚Äôre in a pretty solid space. A little more refinement and connection could take things to the next level.",
                            "You‚Äôve created a foundation of support and safety. Keep reinforcing those positive spaces and relationships.",
                            "Nice progress! Your surroundings and support systems are showing up for you in meaningful ways.",
                        ],
                    },
                    {
                        range: [79.01, 100],
                        list: [
                            "You‚Äôre thriving in a nurturing environment ‚Äî well done! Let‚Äôs celebrate what‚Äôs working and keep it going.",
                            "This score reflects a high level of environmental and relational wellness. Keep surrounding yourself with what uplifts you.",
                            "You‚Äôre in a great place socially and environmentally. Let‚Äôs keep fueling that positive momentum.",
                            "You‚Äôve cultivated meaningful support and a sense of belonging ‚Äî that‚Äôs powerful.",
                            "Strong connections and a safe environment are shining through here. You‚Äôre doing an amazing job.",
                        ],
                    },
                ];

                return pickComment(percentage, messages);
            }

            function pickComment(percentage, messages) {
                const messageGroup = messages.find(({ range }) => percentage >= range[0] && percentage <= range[1]);

                if (messageGroup && messageGroup.list.length > 0) {
                    const randomIndex = Math.floor(Math.random() * messageGroup.list.length);
                    return messageGroup.list[randomIndex];
                } else {
                    return "No comment available for this score.";
                }
            }

            function plotGauges(percA, percB) {
                Plotly.newPlot("gaugeA", [
                    {
                        type: "indicator",
                        mode: "gauge+number",
                        value: percA,
                        title: { text: "Emotional State" },
                        gauge: {
                            axis: { range: [0, 100] },
                            bar: { color: "#a4b0b1" },
                            steps: [
                                { range: [0, 57], color: "#FF0000" },
                                { range: [57, 63], color: "#FF8C00" },
                                { range: [63, 86], color: "#FFFC00" },
                                { range: [86, 100], color: "#00FF00" },
                            ],
                        },
                    },
                ]);

                Plotly.newPlot("gaugeB", [
                    {
                        type: "indicator",
                        mode: "gauge+number",
                        value: percB,
                        title: { text: "Functional Score" },
                        gauge: {
                            axis: { range: [0, 100] },
                            bar: { color: "#a4b0b1" },
                            steps: [
                                { range: [0, 29], color: "#FF0000" },
                                { range: [29, 54], color: "#FF8C00" },
                                { range: [54, 79], color: "#FFFC00" },
                                { range: [79, 100], color: "#00FF00" },
                            ],
                        },
                    },
                ]);
            }

            // Function to determine the background color based on Part A score
            function getColorForPartA(percA) {
                if (percA >= 0 && percA <= 57) return "#FF0000"; // Red
                if (percA > 57 && percA <= 63) return "#FF8C00"; // Orange
                if (percA > 63 && percA <= 86) return "#FFFC00"; // Yellow
                if (percA > 86 && percA <= 100) return "#00FF00"; // Green
                return "#FFFFFF"; // Default white if out of range
            }

            // Function to determine the background color based on Part B score
            function getColorForPartB(percB) {
                if (percB >= 0 && percB <= 29) return "#FF0000"; // Red
                if (percB > 29 && percB <= 54) return "#FF8C00"; // Orange
                if (percB > 54 && percB <= 79) return "#FFFC00"; // Yellow
                if (percB > 79 && percB <= 100) return "#00FF00"; // Green
                return "#FFFFFF"; // Default white if out of range
            }


            function renderAllCharts(percA, percB) {
                const cAScore = Math.round(percA);
                const cBScore = Math.round(percB);

                const partAColor = getColorForPartA(percA);
                const partBColor = getColorForPartB(percB);


                // Function to determine the background color for Part A score in this chart section
                function getColorForPartA_BarChartSection(percA) {
                    console.log("[DEBUG] Calculating color for Part A with score:", percA);
                    if (percA >= 0 && percA <= 57) return "#FF0000"; // Red
                    if (percA > 57 && percA <= 63) return "#FF8C00"; // Orange
                    if (percA > 63 && percA <= 86) return "#FFFC00"; // Yellow
                    if (percA > 86 && percA <= 100) return "#00FF00"; // Green
                    console.warn("[WARNING] Part A score out of expected range:", percA);
                    return "#FFFFFF"; // Default white
                }

                // Function to determine the background color for Part B score in this chart section
                function getColorForPartB_BarChartSection(percB) {
                    console.log("[DEBUG] Calculating color for Part B with score:", percB);
                    if (percB >= 0 && percB <= 29) return "#FF0000"; // Red
                    if (percB > 29 && percB <= 54) return "#FF8C00"; // Orange
                    if (percB > 54 && percB <= 79) return "#FFFC00"; // Yellow
                    if (percB > 79 && percB <= 100) return "#00FF00"; // Green
                    console.warn("[WARNING] Part B score out of expected range:", percB);
                    return "#FFFFFF"; // Default white
                }



                // Gauge Charts (Plotly)
                Plotly.newPlot("gaugeA", [
                    {
                        type: "indicator",
                        mode: "gauge+number",
                        value: percA,
                        title: { text: "Part A Gauge" },
                        gauge: {
                            axis: { range: [0, 100] },
                            bar: { color: "#a4b0b1" },
                            steps: [
                                { range: [0, 57], color: "#FF0000" },
                                { range: [57.01, 63], color: "#FF8C00" },
                                { range: [63.01, 86], color: "#FFFC00" },
                                { range: [86.01, 100], color: "#00FF00" },
                            ],
                        },
                    },
                ]);

                Plotly.newPlot("gaugeB", [
                    {
                        type: "indicator",
                        mode: "gauge+number",
                        value: percB,
                        title: { text: "Functional Score" },
                        gauge: {
                            axis: { range: [0, 100] },
                            bar: { color: "#a4b0b1" },
                            steps: [
                                { range: [0, 29], color: "#FF0000" },
                                { range: [29.01, 54], color: "#FF8C00" },
                                { range: [54.01, 79], color: "#FFFC00" },
                                { range: [79.01, 100], color: "#00FF00" },
                            ],
                        },
                    },
                ]);
            }
        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const calendarEl = document.getElementById("calendar");
                const addTaskBtn = document.getElementById("addTask");
                const saveTaskBtn = document.getElementById("saveTask");
                const deleteTaskBtn = document.getElementById("deleteTask");
                const taskModal = document.getElementById("taskModal");
                let editingEvent = null;

                const moodColors = {
                    Happy: "#fde68a",
                    Calm: "#bae6fd",
                    Motivated: "#bbf7d0",
                    Stressed: "#fecaca",
                    Sad: "#ddd6fe",
                };

                const calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: "dayGridMonth",
                    editable: true,
                    selectable: true,
                    droppable: true,
                    headerToolbar: {
                        start: "title",
                        center: "",
                        end: "prev,next today",
                    },
                    events: JSON.parse(localStorage.getItem("calendarEvents")) || [],
                    eventClick: function (info) {
                        openModal(info.event);
                    },
                    dateClick: function (info) {
                        openModal(null, info.dateStr);
                    },
                    eventDidMount: function (info) {
                        const mood = info.event.extendedProps.mood;
                        if (mood && moodColors[mood]) {
                            info.el.style.backgroundColor = moodColors[mood];
                        }
                        info.el.style.cursor = "pointer";
                    },
                    eventDrop: function (info) {
                        saveToLocal();
                        Toastify({
                            text: "Task moved!",
                            duration: 2000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "#60a5fa",
                        }).showToast();
                    },
                    eventDragStart: function (info) {
                        // Remove ghost image
                        if (info.jsEvent.dataTransfer) {
                            const img = new Image();
                            img.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAEklEQVR42mNk+M/wHwAE/wL+3oylPwAAAABJRU5ErkJggg=="; // transparent pixel
                            info.jsEvent.dataTransfer.setDragImage(img, 0, 0);
                        }
                    },
                    eventDragStop: function (info) {
                        saveToLocal();
                        Toastify({
                            text: "Task moved!",
                            duration: 2000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "#60a5fa",
                        }).showToast();
                    },
                });

                calendar.render();

                function openModal(event = null, dateStr = null) {
                    editingEvent = event;
                    taskModal.style.display = "block";

                    if (event) {
                        document.getElementById("taskTitle").value = event.title;
                        document.getElementById("taskDescription").value = event.extendedProps.description || "";
                        document.getElementById("taskMood").value = event.extendedProps.mood || "";
                        document.getElementById("taskDate").value = event.startStr.split("T")[0];
                        document.getElementById("taskStartTime").value = event.startStr.split("T")[1]?.substring(0, 5) || "";
                        document.getElementById("taskEndTime").value = event.endStr ? event.endStr.split("T")[1]?.substring(0, 5) : "";
                    } else {
                        document.querySelectorAll("#taskModal input, #taskModal textarea, #taskModal select").forEach((input) => (input.value = ""));
                        if (dateStr) {
                            document.getElementById("taskDate").value = dateStr;
                        }
                    }
                }

                window.closeModal = function () {
                    taskModal.style.display = "none";
                    editingEvent = null;
                };

                saveTaskBtn.onclick = function () {
                    const title = document.getElementById("taskTitle").value.trim();
                    const description = document.getElementById("taskDescription").value.trim();
                    const mood = document.getElementById("taskMood").value;
                    const date = document.getElementById("taskDate").value;
                    const startTime = document.getElementById("taskStartTime").value;
                    const endTime = document.getElementById("taskEndTime").value;

                    if (!title || !date) {
                        alert("Please fill at least Title and Date.");
                        return;
                    }

                    const start = startTime ? `${date}T${startTime}` : date;
                    const end = endTime ? `${date}T${endTime}` : start;

                    if (editingEvent) {
                        editingEvent.setProp("title", title);
                        editingEvent.setStart(start);
                        editingEvent.setEnd(end);
                        editingEvent.setExtendedProp("description", description);
                        editingEvent.setExtendedProp("mood", mood);
                    } else {
                        calendar.addEvent({
                            title: title,
                            start: start,
                            end: end,
                            extendedProps: { description, mood },
                        });
                    }

                    saveToLocal();
                    Toastify({
                        text: editingEvent ? "Task updated!" : "Task added!",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "#34d399",
                    }).showToast();
                    closeModal();
                };

                deleteTaskBtn.onclick = function () {
                    if (editingEvent) {
                        editingEvent.remove();
                        saveToLocal();
                        Toastify({
                            text: "Task deleted!",
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "#f87171",
                        }).showToast();
                        closeModal();
                    }
                };

                function saveToLocal() {
                    const events = calendar.getEvents().map((event) => ({
                        title: event.title,
                        start: event.startStr,
                        end: event.endStr || event.startStr,
                        extendedProps: event.extendedProps,
                    }));
                    localStorage.setItem("calendarEvents", JSON.stringify(events));
                }
            });
        </script>
    </body>
</html>
